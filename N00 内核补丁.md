# N00 内核补丁

这个小主机需要打两个补丁，一个是关于显卡 `sriov` 的补丁,另外一个是关于风扇的补丁 `IT87`.

- 显卡补丁 `i915-sriov-dkms`  这个在上篇已经介绍了。
- 风扇 `IT87` 补丁

项目都在github，大家搜索可以下到，为了比较懒的小伙伴，我计划把修改好的内核上传到github，大家可以直接下载到，再做个脚本文件，全自动化也不是不可以，一键脚本？

## IT87 补丁

这篇主要介绍风扇驱动的 `it87` 补丁,  下载关键字：`a1wong/it87`

- 下载补丁 
- 安装补丁

```
Building & Installing
---------------------

* make clean
* make
* sudo make install


Using DKMS
----------

To install:

* sudo make dkms

To remove:

* sudo make dkms_clean
```

### 搞完了以后还需要添加一个驱动启用文件

编辑  `/etc/modules-load.d/it87.conf`

添加 `it87`

大家可以用我提供的现成的命令执行：

`echo "it87" > /etc/modules-load.d/it87.conf`

### 还是常规，更新initramfs

`Update-initramfs -u -k all`

### 重启

`reboot`

## 检查是否成功

检查驱动是否加载

`lsmod | grep it87`

需要先安装 `lm-sensors`

- 安装

`apt install lm-sensor`

- 传感器检测

`sensors-detect --auto`

- 如果内核补丁打好了，就会如下显示：

注意会出现 `fan`也就是风扇.

 `fan2:         514 RPM  (min =   10 RPM)`

如果没打补丁，会检测不到风扇。

```
# sensors
coretemp-isa-0000 # cpu 核心温度
Adapter: ISA adapter
Package id 0:  +46.0°C  (high = +105.0°C, crit = +105.0°C)
Core 0:        +43.0°C  (high = +105.0°C, crit = +105.0°C)
Core 1:        +43.0°C  (high = +105.0°C, crit = +105.0°C)
Core 2:        +43.0°C  (high = +105.0°C, crit = +105.0°C)
Core 3:        +43.0°C  (high = +105.0°C, crit = +105.0°C)

nvme-pci-0500 # 这里是 nvme 的温度
Adapter: PCI adapter
Composite:    +43.9°C  (low  = -273.1°C, high = +89.8°C)
                       (crit = +94.8°C)
Sensor 1:     +44.9°C  (low  = -273.1°C, high = +65261.8°C)
Sensor 2:     +49.9°C  (low  = -273.1°C, high = +65261.8°C)

it8613-isa-0a30 # 这里IT87传感器，我们打补丁的目的，风扇速度啥的出来了！
Adapter: ISA adapter
in0:         748.00 mV (min =  +2.50 V, max =  +0.66 V)  ALARM
in1:           1.20 V  (min =  +0.89 V, max =  +1.67 V)
in2:           2.01 V  (min =  +2.20 V, max =  +0.04 V)  ALARM
in4:           2.02 V  (min =  +0.08 V, max =  +0.02 V)  ALARM
in5:           1.99 V  (min =  +0.40 V, max =  +0.57 V)  ALARM
3VSB:          3.28 V  (min =  +3.76 V, max =  +2.31 V)  ALARM
Vbat:          2.73 V
+3.3V:         3.28 V
fan2:         514 RPM  (min =   10 RPM) # 风扇转速
fan3:           0 RPM  (min =   13 RPM)  ALARM
temp1:        +54.0°C  (low  = +49.0°C, high = -87.0°C)  ALARM  sensor = thermal diode
temp2:        +44.0°C  (low  =  -2.0°C, high = +124.0°C)  sensor = thermal diode
temp3:        +54.0°C  (low  = +35.0°C, high = +48.0°C)  ALARM
intrusion0:  ALARM
```

#### 很显然我这个已经成功了！

# 感谢阅读

